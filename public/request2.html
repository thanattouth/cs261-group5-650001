<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thammasat University</title>
    <link rel="stylesheet" href="./style/stylerequest2.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=K2D:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800&display=swap');
    </style>
</head>
<body>
    <header class="header">
        <img src="./image/Emblem_of_Thammasat_University.svg.png" alt="Thammasat University Logo" class="logo">
        <h1>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå<br>THAMMASAT UNIVERSITY</h1>
    </header>
    <div class="container">
        <nav class="sidebar">
            <ul>
                <a href="home.html"><li id="home-nav">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</li></a>
                <a id="dynamicLink" href="request0.html">
                    <li id="req1-nav">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</li>
                </a>
                <a href="listrequest.html"><li id="list-nav">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</li></a>               
            </ul>
            <div class="logout-container">
                <li class="logout" id="logout-nav">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</li>
            </div>
        </nav>
        <div class="main-content">
            <h1>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡∏Å‡∏ñ‡∏≠‡∏ô</h1>
            <form id="requestForm" onsubmit="return validateForm()">
                <input type="hidden" id="requestType" value="2">
                <select name="request" id="request">
                    <option value="0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</option>
                    <option value="1">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</option>
                    <option value="2">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡∏Å‡∏ñ‡∏≠‡∏ô</option>
                    <option value="3">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏Ç‡∏≤‡∏î‡∏™‡∏≠‡∏ö</option>
                    <option value="4">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                </select>
                <div class="form-group">
                    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input  
                        type="date" 
                        class="date-input"
                        id="date" 
                        placeholder="‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ"
                        required 
                        maxlength="10"
                    >       

                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="name" required>
                    </div>
                    <div>
                        <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label>
                        <input 
                        type="text" 
                        id="id" 
                        placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" 
                        required 
                        maxlength="10"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        >
                    </div>
                    <div>
                        <label>‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <input type="text" id="faculty" required>
                    </div>
                    <div>
                        <label>‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
                        <input  
                        type="text" class="p-input"
                        id="year" 
                        placeholder="‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ" 
                        required 
                        maxlength="1"
                        oninput="this.value = this.value.replace(/[^1-8]/g, '')"
                        >
                    </div>
                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</label>
                        <input type="text" id="address" required>
                    </div>
                    <div>
                        <label>‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•</label>
                        <input type="text" id="district" required>
                    </div>
                    <div>
                        <label>‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                        <input type="text" id="subdistrict" required>
                    </div>
                    <div>
                        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                        <input type="text" id="province" required>
                    </div>
                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                        <input 
                        type="text" 
                        id="student-tel" 
                        placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" 
                        required 
                        maxlength="10"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        >
                    </div>
                    <div>
                        <label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                        <input 
                        type="text" 
                        id="parent-tel" 
                        placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á" 
                        required 
                        maxlength="10"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        >
                    </div>
                    <div>
                        <label>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label>
                        <input type="text" id="advisor" required>
                    </div>
                </div>
                <div class="textt">
                    <h3>‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏à‡∏∞‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ / ‡∏ñ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="text" 
                        id="semester"  
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô 1/2566" 
                        required 
                        maxlength="6"
                        pattern="^[0-9]{1}/[0-9]{4}$"
                        oninput="validateSemester()"
                        >
                        <span id="semester-error" style="color: red; display: none;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô 1/2566</span>
                    </div>
                    <div>
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <input type="text" id="courseCode" required>
                    </div>
                    <div>
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <input type="text" id="courseName" required>
                    </div>
                    <div>
                        <label>section</label>
                        <input type="text" id="section" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å</label>
                    <textarea rows="4" id="reason" required></textarea>
                </div>
                <div class="form-group">
                    <label>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå:</label>
                    <button type="button" class="custom-file-button" onclick="document.getElementById('attachment').click();">Choose Files</button>
                    <input type="file" id="attachment" name="attachments" class="file-input" style="display: none;" multiple>
                    <div id="file-list"></div>
                    
                    <label>‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô PDF ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô:</label>
                    <button type="button" class="custom-file-button merge-pdf-button">‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô PDF</button><br><br><br>
                    <button type="button" class="custom-file-button submit" id = "submitButton">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</button>
                </div>
                <div id="myModal" class="modal">
                    <div class="modal-content">
                        <p>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á<br>‡∏Ç‡∏≠‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</p><br>
                        <button id="confirmBtn" class="button confirm-btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button id="cancelBtn" class="button cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script src="./js/request2ToBackend.js"></script>
    <script src="./js/request2.js"></script>
    <script src="./js/request.js"></script>
    <script src="./js/sessionUtils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>  

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const attachmentInput = document.getElementById('attachment');
            const fileListContainer = document.getElementById('file-list');
            const dt = new DataTransfer();
            const MAX_FILES = 5;
            const MAX_SIZE = 302400; // 300 KB in bytes

            attachmentInput.addEventListener('change', function() {
                const newFiles = Array.from(this.files);
                const currentFileCount = dt.items.length;
        
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                if (currentFileCount + newFiles.length > MAX_FILES) {
                    showNotification(`‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${MAX_FILES} ‡πÑ‡∏ü‡∏•‡πå (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentFileCount} ‡πÑ‡∏ü‡∏•‡πå)`);
                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                    this.value = '';
                    return;
                }

                newFiles.forEach(file => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    if ((file.type === "application/pdf" || file.type.startsWith('image/')) && file.size > MAX_SIZE) {
                        showNotification("‡πÑ‡∏ü‡∏•‡πå PDF ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 300 KB");
                        return;
                    }
                    dt.items.add(file);
                    addFileItem(file);
                });

                attachmentInput.files = dt.files;
            });

            function addFileItem(file) {
                const fileItem = document.createElement('div');
                fileItem.classList.add('file-item');

                const fileLink = document.createElement('a');
                fileLink.href = URL.createObjectURL(file);
                fileLink.download = file.name;
                fileLink.classList.add('file-name');
                fileLink.target = '_blank';
                fileLink.textContent = file.type === "application/pdf" ? 'üìÑ ' : (file.type.startsWith('image/') ? 'üñºÔ∏è ' : 'üìÑ ');
                fileLink.appendChild(document.createTextNode(` ${file.name} (${(file.size / 1024).toFixed(2)} KB)`));

                fileItem.appendChild(fileLink);

                const renameButton = createRenameButton(file, fileLink);
                fileItem.appendChild(renameButton);

                const removeButton = createRemoveButton(file, fileItem);
                fileItem.appendChild(removeButton);

                fileListContainer.appendChild(fileItem);
                const remainingFiles = dt.files.length;
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remainingFiles} ‡∏à‡∏≤‡∏Å ${MAX_FILES} ‡πÑ‡∏ü‡∏•‡πå)`);
            }

            function createRenameButton(file, fileLink) {
                const button = document.createElement('button');
                button.textContent = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠";
                button.classList.add('rename-file-button');

                const updateRenameHandler = (currentFile) => {
                    return (event) => {
                        event.preventDefault();
                        const newName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà:", currentFile.name);
                        if (newName && newName !== currentFile.name) {
                            const updatedFile = new File([currentFile], newName, { type: currentFile.type });
        
                            // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô DataTransfer
                            const fileIndex = Array.from(dt.files).findIndex(f => 
                                f.name === currentFile.name && 
                                f.size === currentFile.size && 
                                f.type === currentFile.type
                            );

                            if (fileIndex !== -1) {
                                // ‡∏™‡∏£‡πâ‡∏≤‡∏á DataTransfer ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                const newDt = new DataTransfer();
                                Array.from(dt.files).forEach((f, index) => {
                                    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß
                                    newDt.items.add(index === fileIndex ? updatedFile : f);
                                });

                                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DataTransfer ‡∏´‡∏•‡∏±‡∏Å
                                dt.items.clear();
                                Array.from(newDt.files).forEach(f => dt.items.add(f));
            
                                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï input file
                                attachmentInput.files = dt.files;

                                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                                fileLink.href = URL.createObjectURL(updatedFile);
                                fileLink.download = newName;
                                const fileIcon = fileLink.textContent.split(' ')[0];
                                fileLink.textContent = `${fileIcon} ${newName} (${(updatedFile.size / 1024).toFixed(2)} KB)`;
                    
                                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
                                const removeButton = fileLink.parentElement.querySelector('.remove-file-button');
                                if (removeButton) {
                                    removeButton.onclick = createRemoveButton(updatedFile, fileLink.parentElement).onclick;
                                }

                                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï handler ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                                button.onclick = updateRenameHandler(updatedFile);
                            }
                        }
                    };
                };

            button.onclick = updateRenameHandler(file);
            return button;
            }
    
            function createRemoveButton(file, fileItem) {
                const button = document.createElement('button');
                button.innerHTML = "&#10006;";
                button.classList.add('remove-file-button');
                button.onclick = () => {
                    // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÉ‡∏ô DataTransfer
                    const fileIndex = Array.from(dt.files).findIndex(f => 
                        f.name === file.name && f.size === file.size && f.type === file.type
                    );
            
                    if (fileIndex !== -1) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á DataTransfer ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                        const newDt = new DataTransfer();
                        Array.from(dt.files).forEach((f, index) => {
                            if (index !== fileIndex) newDt.items.add(f);
                        });
                
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DataTransfer ‡πÅ‡∏•‡∏∞ input
                        dt.items.clear();
                        Array.from(newDt.files).forEach(f => dt.items.add(f));
                        attachmentInput.files = dt.files;
    
                        // ‡∏•‡∏ö UI element
                        fileItem.remove();
                
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                        const remainingFiles = dt.files.length;
                        showNotification(`‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remainingFiles} ‡∏à‡∏≤‡∏Å ${MAX_FILES} ‡πÑ‡∏ü‡∏•‡πå)`);
                    }
                };
                return button;
            }

            // Function to display the custom notification
            function showNotification(message) {
                // Create a new notification element
                const notification = document.createElement("div");
                notification.className = "notification-popup";
                notification.innerText = message;
        
                // Append the notification to the body
                document.body.appendChild(notification);

                // Automatically remove the notification after 3 seconds
                setTimeout(() => {
                    notification.classList.add("fade-out");
                    setTimeout(() => {
                        notification.remove();
                    }, 500); // Wait for fade-out animation to complete
                }, 3000); // Display for 3 seconds
            }

            function resetFiles() {
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå DataTransfer object
                dt.items.clear();
        
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input file
                attachmentInput.value = '';
        
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô UI
                fileListContainer.innerHTML = '';
        
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï files ‡∏Ç‡∏≠‡∏á input
                attachmentInput.files = dt.files;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const style = document.createElement('style');
            style.textContent = `
                .notification-popup {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background-color: #4CAF50;
                    color: white;
                    font-size: 16px;
                    border-radius: 5px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    opacity: 1;
                    transition: opacity 0.5s ease;
                    z-index: 1000;
                    animation: slideIn 0.5s ease-out;
                }

                .fade-out {
                    opacity: 0;
                    transition: opacity 0.5s;
                }

                @keyframes slideIn {
                    from {
                       transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);

            // ‡πÅ‡∏™‡∏î‡∏á modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á"
            document.getElementById("submitButton").onclick = function() {
                if (validateForm()) {
                    document.getElementById("myModal").style.display = "block";
                }
            };

            // ‡∏ã‡πà‡∏≠‡∏ô modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
            document.getElementById("cancelBtn").onclick = function() {
                document.getElementById("myModal").style.display = "none";
            };

            // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á
            document.getElementById("confirmBtn").onclick = function() {        
                if (validateForm()) {
                    document.getElementById("myModal").style.display = "none";
                    const userData = JSON.parse(localStorage.getItem('userData'));
                    Swal.fire({
                        icon: "success",
                        title: "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
                        showConfirmButton: false,
                        timer: 1500
                    });
                    clearNonReadOnlyFields();
                    resetFiles();
                    clearDraftAfterSubmit();

                    fetch('/send-confirmation-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: userData.email, name: userData.displayname_th})
                    })
                }
                const userId = sessionStorage.getItem('userId') || 'defaultUser';
                const fields = [
                    'name', 'id', 'faculty', 'year', 'address', 'district', 
                    'subdistrict', 'province', 'student-tel', 'parent-tel', 
                    'advisor', 'semester', 'courseCode', 'courseName', 
                    'section', 'reason'
                ];
    
                fields.forEach(field => {
                    localStorage.removeItem(getStorageKey(field, userId));  // Remove only the form-related keys
                });
            }
            document.querySelector('.merge-pdf-button').addEventListener('click', async function() {
                const pdfFiles = Array.from(dt.files).filter(file => file.type === "application/pdf");
                if (pdfFiles.length === 0) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°");
                    return;
                }

                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                for (const file of pdfFiles) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const mergedFile = new File([blob], "merged.pdf", { type: "application/pdf" });

                // Clear all old PDF files and add the new merged PDF
                const nonPdfFiles = Array.from(dt.files).filter(file => file.type !== "application/pdf");
                dt.items.clear();
                dt.items.add(mergedFile);
                nonPdfFiles.forEach(file => dt.items.add(file));
                attachmentInput.files = dt.files;

                // Clear and re-add all files including the new merged PDF
                fileListContainer.innerHTML = '';
                Array.from(dt.files).forEach(file => addFileItem(file));
            });
        });
    </script>
    <script src="./js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          sessionManager.preventBackAfterLogout();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>