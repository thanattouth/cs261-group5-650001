<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thammasat University</title>
    <link rel="stylesheet" href="./style/stylerequest1.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=K2D:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800&display=swap');
    </style>
</head>
<body>
    <header class="header">
        <img src="./image/Emblem_of_Thammasat_University.svg.png" alt="Thammasat University Logo" class="logo">
        <h1>มหาวิทยาลัยธรรมศาสตร์<br>THAMMASAT UNIVERSITY</h1>
    </header>
    <div class="container">
        <nav class="sidebar">
            <ul>
                <a href="home.html"><li id="home-nav">หน้าแรก</li></a>
                <a href="request1.html"><li id="req1-nav">การเขียนคำร้อง</li></a>
            </ul>
            <div class="logout-container">
                <li id="logout-nav">ออกจากระบบ</li>
            </div>
        </nav>
        <div class="main-content">
            <h1>เขียนคำร้องขอจดทะเบียนล่าช้า</h1>
            <form id="requestForm" onsubmit="return validateForm()">
                <div class="form-group">
                    <label>วันที่</label>
                    <input  
                        type="date" 
                        class="date-input"
                        id="date" 
                        placeholder="วว/ดด/ปปปป"
                        required 
                        maxlength="10"
                    >       

                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>ชื่อ-นามสกุล</label>
                        <input type="text" id="name" required>
                    </div>
                    <div>
                        <label>เลขทะเบียน</label>
                        <input 
                        type="text" 
                        id="id" 
                        placeholder="เลขทะเบียน" 
                        required 
                        maxlength="10"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        >
                    </div>
                    <div>
                        <label>สาขา</label>
                        <input type="text" id="faculty" required>
                    </div>
                    <div>
                        <label>ชั้นปี</label>
                        <input  
                        type="text" class="p-input"
                        id="year" 
                        placeholder="ชั้นปี" 
                        required 
                        maxlength="1"
                        oninput="this.value = this.value.replace(/[^1-8]/g, '')"
                        
                        >
                    </div>
                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>ที่อยู่ที่ติดต่อได้</label>
                        <input type="text" id="address" required>
                    </div>
                    <div>
                        <label>แขวง/ตำบล</label>
                        <input type="text" id="district" required>
                    </div>
                    <div>
                        <label>เขต/อำเภอ</label>
                        <input type="text" id="subdistrict" required>
                    </div>
                    <div>
                        <label>จังหวัด</label>
                        <input type="text" id="province" required>
                    </div>
                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>โทรศัพท์นักศึกษา</label>
                        <input 
                        type="text" 
                        id="student-tel" 
                        placeholder="เบอร์โทรศัพท์นักศึกษา" 
                        required 
                        maxlength="10"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        >
                    </div>
                    <div>
                        <label>โทรศัพท์ผู้ปกครอง</label>
                        <input 
                        type="text" 
                        id="parent-tel" 
                        placeholder="เบอร์โทรศัพท์ผู้ปกครอง" 
                        required 
                        maxlength="10"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        >
                    </div>
                    <div>
                        <label>อาจารย์ที่ปรึกษา</label>
                        <input type="text" id="advisor" required>
                    </div>
                </div>
                <div class="textt">
                    <h3>ประสงค์จะยื่นคำร้องจดทะเบียนล่าช้า</h3>
                </div>
                <div class="form-group multi-column">
                    <div>
                        <label>ภาคเรียนที่</label>
                        <input type="text" 
                        id="semester"  
                        placeholder="เช่น 1/2566" 
                        required 
                        maxlength="6"
                        pattern="^[0-9]{1}/[0-9]{4}$"
                        oninput="validateSemester()"
                        >
                        <span id="semester-error" style="color: red; display: none;">กรุณากรอกภาคการศึกษาให้ถูกต้อง เช่น 1/2566</span>
                    </div>
                    <div>
                        <label>รหัสวิชา</label>
                        <input type="text" id="courseCode" required>
                    </div>
                    <div>
                        <label>ชื่อวิชา</label>
                        <input type="text" id="courseName" required>
                    </div>
                    <div>
                        <label>section</label>
                        <input type="text" id="section" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>เหตุผลที่ยื่นคำร้องเนื่องจาก</label>
                    <textarea rows="4" id="reason" required></textarea>
                </div>
                <div class="form-group">
                    <label>แนบไฟล์:</label>
                    <button type="button" class="custom-file-button" onclick="document.getElementById('attachment').click();">Choose Files</button>
                    <input type="file" id="attachment" name="attachments" class="file-input" style="display: none;" multiple>
                    <div id="file-list"></div>
                    
                    <label>รวมไฟล์ PDF ทั้งหมดเป็น PDF เดียวกัน:</label>
                    <button type="button" class="custom-file-button merge-pdf-button">รวมไฟล์เป็น PDF</button><br><br><br>
                    <button type="button" class="custom-file-button submit" id = "submitButton">ส่งคำร้อง</button>
                </div>
                <div id="myModal" class="modal">
                    <div class="modal-content">
                        <p>ยืนยันการส่งคำร้อง<br>ขอจดทะเบียนล่าช้า</p><br>
                        <button id="confirmBtn" class="button confirm-btn">ยืนยัน</button>
                        <button id="cancelBtn" class="button cancel-btn">ยกเลิก</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script src="./js/saveRequesttoBackend.js"></script>
    <script src="./js/request1.js"></script>
    <script src="./js/sessionUtils.js"></script>
    <script src="./js/logout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const attachmentInput = document.getElementById('attachment');
            const fileListContainer = document.getElementById('file-list');
            const dt = new DataTransfer();
            
            document.querySelector('.merge-pdf-button').addEventListener('click', async function() {
                const pdfFiles = Array.from(dt.files).filter(file => file.type === "application/pdf");
                if (pdfFiles.length === 0) {
                    alert("กรุณาเลือกไฟล์ PDF สำหรับการรวม");
                    return;
                }

                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                for (const file of pdfFiles) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const mergedFile = new File([blob], "merged.pdf", { type: "application/pdf" });

                // Clear all old PDF files and add the new merged PDF
                const nonPdfFiles = Array.from(dt.files).filter(file => file.type !== "application/pdf");
                dt.items.clear();
                dt.items.add(mergedFile);
                nonPdfFiles.forEach(file => dt.items.add(file));
                attachmentInput.files = dt.files;

                // Clear and re-add all files including the new merged PDF
                fileListContainer.innerHTML = '';
                Array.from(dt.files).forEach(file => addFileItem(file));
            });
        });
    </script>
</body>
</html>